version: "3.5"

volumes:
  redis_data:
  rabbitmq_data:
  mongo_data:
  minio_data:

services:
  minio:
    image: minio/minio
    container_name: image-resize-minio # boto does not support underscores in host names
    ports:
      - "9000:9000"
      - "9090:9090" # terminal
    environment:
      - MINIO_ROOT_USER=$MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
    volumes:
      - minio_data:/data
    command: [ "server", "--console-address", ":9090", "--address", ":9000", "/data" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  mc:
    image: minio/mc
    container_name: image-resize-mc
    depends_on:
      - minio
    environment:
      - MINIO_ROOT_USER=$MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://image-resize-minio:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD --api S3v4;
      mc admin trace myminio --verbose;
      "
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: image-resize-rabbitmq
    restart: unless-stopped
    ports:
      - "15672:15672"
      - "5672:5672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  redis:
    image: redis:7
    container_name: image-resize-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: [ 'redis-server', '--appendonly', 'yes' ]
    volumes:
      - redis_data:/data

  mongo:
    image: mongo
    container_name: image-resize-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - ./mongo/docker-entrypoint-initdb.d/:/docker-entrypoint-initdb.d/
      - mongo_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$MONGO_INITDB_ROOT_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD=$MONGO_INITDB_ROOT_PASSWORD

  mongo-express:
    image: mongo-express
    container_name: image-resize-mongo-express
    restart: unless-stopped
    depends_on:
      - mongo
    ports:
      - "8081:8081" # terminal
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=$MONGO_INITDB_ROOT_USERNAME
      - ME_CONFIG_MONGODB_ADMINPASSWORD=$MONGO_INITDB_ROOT_PASSWORD
      - ME_CONFIG_MONGODB_URL=$MONGO_URL

        #  postgres:
        #    image: postgres
        #    restart: unless-stopped
        #    container_name: postgres_dev
        #    ports:
        #      - "5432:5432"
        #    env_file:
        #      - .env.dev.postgres
        #    volumes:
        #      - ./postgres-init-db.sh:/docker-entrypoint-initdb.d/postgres-init-db.sh
      #      - ./postgres_data_dev/:/var/lib/postgresql/data


      # TODO containerise celery worker and main app

#      web:
#        build: ./project
#        ports:
#          - 8004:8000
#        command: uvicorn main:app --host 0.0.0.0 --reload
#        volumes:
#          - ./project:/usr/src/app
#        environment:
#          - CELERY_BROKER_URL=redis://redis:6379/0
#          - CELERY_RESULT_BACKEND=redis://redis:6379/0
#        depends_on:
#          - redis
#
#      worker:
#        build: ./project
#        command: celery -A worker.celery worker --loglevel=info
#        volumes:
#          - ./project:/usr/src/app
#        environment:
#          - CELERY_BROKER_URL=redis://redis:6379/0
#          - CELERY_RESULT_BACKEND=redis://redis:6379/0
#        depends_on:
#          - web
#          - redis







